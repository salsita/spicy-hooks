# `spicy prepare-release`

Pulls the latest release draft linked to the current Git branch from GitHub and:

* distributes changes from the release notes into appropriate change logs
(based on `changelogs` property within the root `package.json`)

* sets versions within `package.json` of every workspace package to value
specified in the release
(see the [spicy set-version](set-version.md) for more info)

Changes generated by this command are meant to be committed and pushed to the
repository prior publishing the release.

## Configuration

This command expects `changelogs` property within the root `package.json`.
This property defines how release notes of the latest draft release are parsed and distributed to individual changelogs.

```json
{
  ...

  "changelogs": {
    "separator": "\n## ",
    "mappings": [
      {
        "pattern": "(.)",
        "packageName": "project-package"
      },
      {
        "pattern": "^(## ) Package A - ",
        "packageName": "package-a"
      },
      {
        "pattern": "^(## ) Package B - ",
        "file": "packages/package-b/CHANGELOG.md"
      }
    ]
  }
}
``` 

The above example splits the release notes by sections using `\n## ` RegExp as a separator.
Individual sections are then prepended to target changelogs based on whether the `pattern` RegExp matches the section.

### `separator`
A regular expression pattern that identifies individual sections of the release notes.
Note that the separator is **not** cut off when splitting the release notes.

### `mappings`
List of mappings between individual sections of release notes and their target changelog file.

#### `pattern`
A regular expression pattern that selects sections which should go into the target changelog.

**Important:** Note that the matching string is by default stripped of the text appended to the changelog.
To make selected parts preserved, wrap them into a RegExp capture group (`(preserved) stripped`).
 
#### `packageName` or `file`
You can either specify a direct path to a concrete changelog by using the `file` or let the tool infer
the location from a `packageName`.

For example specifying `"packageName": "package-a"` will make the tool find a workspace package with a name `package-a`
and use `<package-directory>/CHANGELOG.md` as the target changelog file.
 
## Synopsis

```shell script
spicy prepare-release [--token <github-token>] [--root path]
```

```shell script
spicy prepare-release --help
```

## Options

*  `-t, --token <github-token>`
   * GitHub repo token to list the latest releases from a private repository
   * (defaults to `$GITHUB_TOKEN` env)
                               
* `-r, --root path`
    * Path to the root package (i.e. directory where the root `package.json` is located)
    * (defaults to `./`)
    
* `-h, --help`
    * Display usage guide
